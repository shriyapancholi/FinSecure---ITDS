{% extends "base.html" %}

{% block title %}User Management â€” Sentinel{% endblock %}

{% block content %}
<style>
  /* Page header */
  .um-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .um-head h1{margin:0;color:var(--accent);font-weight:800}

  /* Card/table wrapper */
  .um-card{
    background: var(--card-bg);
    border-radius: 14px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(0,0,0,0.04);
    padding: 16px 18px;
  }
  body.theme-dark .um-card{ border-color: rgba(255,255,255,0.10); }

  /* Table */
  table.um{width:100%; border-collapse:separate; border-spacing:0 8px;}
  table.um thead th{
    font-weight:700; color:var(--text-dark); font-size:14px; padding:10px 12px;
    border-bottom:1px solid rgba(0,0,0,0.06);
  }
  body.theme-dark table.um thead th{ border-color: rgba(255,255,255,0.12); }
  table.um tbody tr{ background: rgba(255,255,255,0.9); }
  table.um tbody td{ padding:12px; font-size:14px; border-top:1px solid rgba(0,0,0,0.04); }
  table.um tbody tr:first-child td{ border-top:none; }
  body.theme-dark table.um tbody tr{ background: rgba(255,255,255,0.06); }
  body.theme-dark table.um tbody td{ border-color: rgba(255,255,255,0.10); }

  /* Small buttons that match the app */
  .um-btn{ background:transparent; border:1px solid rgba(0,0,0,0.12); padding:6px 10px; border-radius:8px; font-weight:600; }
  .um-btn:hover{ transform: translateY(-1px); }
  .um-btn.resume{ color: var(--success); }
  .um-btn.delete{ color: var(--danger); }
  body.theme-dark .um-btn{ border-color: rgba(255,255,255,0.18); }

  .pill-role{
    display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; font-size:12px;
    background: rgba(0,0,0,0.06); color: var(--text-dark);
  }
  body.theme-dark .pill-role{ background: rgba(255,255,255,0.12); }
</style>

<div class="container">
  <div class="um-head">
    <h1>User Management</h1>
    <div style="display:flex; gap:8px">
      <button id="theme_toggle_um" class="resume-btn">Change Mode</button>
    </div>
  </div>

  <div class="um-card">
    <table class="um">
      <thead>
        <tr>
          <th style="width:70px">ID</th>
          <th>User</th>
          <th style="width:160px">Role</th>
          <th style="width:140px">Suspended?</th>
          <th style="width:220px">Actions</th>
        </tr>
      </thead>
      <tbody id="um_tbody">
        {% for u in users %}
        <tr>
          <td>{{ u.id }}</td>
          <td>{{ u.username }}</td>
          <td>
            <span class="pill-role">{{ (u.role or 'analyst') }}</span>
          </td>
          <td>
            {% if u.suspended_until %}
              {% set su = u.suspended_until %}
              {# show Yes only if in future; simple text fallback #}
              Yes (until {{ su }})
            {% else %}
              No
            {% endif %}
          </td>
          <td>
            <button class="um-btn resume" data-uid="{{ u.id }}" data-uname="{{ u.username }}">Resume</button>
            <button class="um-btn delete" data-uid="{{ u.id }}" data-uname="{{ u.username }}">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // ---------- Theme sync (same as other pages) ----------
  const tBtn = document.getElementById('theme_toggle_um');
  function applyTheme(t){
    if(t==='dark') document.body.classList.add('theme-dark');
    else document.body.classList.remove('theme-dark');
    localStorage.setItem('sentinel_theme', t);
  }
  tBtn.addEventListener('click', ()=>{
    const cur = localStorage.getItem('sentinel_theme') || 'light';
    applyTheme(cur === 'light' ? 'dark' : 'light');
  });
  (function initTheme(){
    const t = localStorage.getItem('sentinel_theme') || 'light';
    applyTheme(t);
  })();

  // ---------- Actions (Resume / Delete) ----------
  const tbody = document.getElementById('um_tbody');

  // Delegate clicks to buttons inside the table
  tbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;

    const uid = btn.dataset.uid;
    const uname = btn.dataset.uname || '';

    if(btn.classList.contains('resume')){
      if(!confirm(`Resume user '${uname}'?`)) return;
      try{
        const res = await fetch('/api/users/resume', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id: uid, username: uname })
        });
        const js = await res.json();
        if(res.ok){
          alert(js.message || 'User resumed');
          location.reload();
        }else{
          alert(js.error || 'Resume failed');
        }
      }catch(err){
        alert('Error: ' + err);
      }
    }

    if(btn.classList.contains('delete')){
      const reason = prompt(`Delete user '${uname}'.\n(Optional) Enter a reason for audit:`) || '';
      if(!confirm(`Are you sure you want to DELETE '${uname}'? This cannot be undone.`)) return;
      try{
        const res = await fetch('/api/users/delete', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id: uid, username: uname, reason })
        });
        const js = await res.json();
        if(res.ok){
          alert(js.message || 'User deleted');
          location.reload();
        }else{
          alert(js.error || 'Delete failed');
        }
      }catch(err){
        alert('Error: ' + err);
      }
    }
  });
</script>
{% endblock %}