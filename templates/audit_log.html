{% extends 'base.html' %}
{% block title %}Audit Log — Sentinel{% endblock %}

{% block content %}
<style>
  .audit-card{background:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);
              border:1px solid rgba(0,0,0,0.06)}
  .audit-row{border:1px solid rgba(0,0,0,0.06);border-radius:10px;padding:12px;margin-bottom:10px;
             background:var(--card-bg)}
  .mut{color:var(--muted)}
  .pill{display:inline-block;padding:.28rem .55rem;border-radius:999px;font-weight:700;font-size:.78rem}
  .pill.del{background:var(--danger);color:#fff}
  .pill.res{background:var(--success);color:#fff}
  .k{font-weight:600}
  pre.audit-json{background:#0f2730;color:#bfeee0;border-radius:8px;padding:10px;white-space:pre-wrap;
                 border:1px solid rgba(0,0,0,0.06);margin:0}
  body.theme-dark .audit-row{border-color:rgba(255,255,255,0.12)}
  body.theme-dark pre.audit-json{background:rgba(255,255,255,0.06);color:var(--text-dark);
                                 border-color:rgba(255,255,255,0.12)}
</style>

<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h3" style="color:var(--accent);margin:0">Audit Log</h1>
      <div class="mut">Who did what, to whom, when — resume/delete and other sensitive actions.</div>
    </div>
    <div class="d-flex gap-2">
      <button id="theme_toggle_audit" class="btn btn-outline-light">Change Mode</button>
      {% if session.get('role') == 'admin' %}
        <a class="btn btn-accent" href="{{ url_for('api_audit_export') }}">Export CSV</a>
      {% endif %}
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="card-panel mb-3" style="padding:14px">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label muted">Action</label>
        <select name="action" class="form-select">
          <option value="" {{ '' == q_action and 'selected' or '' }}>All</option>
          <option value="delete_user" {{ 'delete_user' == q_action and 'selected' or '' }}>delete_user</option>
          <option value="resume_user" {{ 'resume_user' == q_action and 'selected' or '' }}>resume_user</option>
          <option value="login_success" {{ 'login_success' == q_action and 'selected' or '' }}>login_success</option>
          <option value="user_deleted" {{ 'user_deleted' == q_action and 'selected' or '' }}>user_deleted</option>
          <option value="user_resumed" {{ 'user_resumed' == q_action and 'selected' or '' }}>user_resumed</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label muted">Actor (who performed)</label>
        <input name="actor" class="form-control" value="{{ q_actor or '' }}" placeholder="username">
      </div>
      <div class="col-12 col-md-3">
        <button class="btn btn-accent">Apply</button>
        <a class="btn btn-outline-light" href="{{ url_for('audit_log') }}">Clear</a>
      </div>
    </div>
  </form>

  <!-- List -->
  <div class="audit-card p-3">
    {% if items and items|length > 0 %}
      {% for a in items %}
        <div class="audit-row">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="k">Action:</div>
              <div>
                {% if a.action == 'delete_user' %}
                  <span class="pill del">{{ a.action }}</span>
                {% elif a.action == 'resume_user' %}
                  <span class="pill res">{{ a.action }}</span>
                {% else %}
                  <span class="pill" style="background:#ddd;color:#222">{{ a.action }}</span>
                {% endif %}
              </div>
              <div class="mt-2"><span class="k">Actor:</span> {{ a.actor or '—' }} &nbsp; • &nbsp;
                  <span class="k">Target:</span> {{ a.target_user or '—' }}</div>
              {% if a.reason %}
                <div class="mt-1"><span class="k">Reason:</span> {{ a.reason }}</div>
              {% endif %}
              <div class="mut small mt-1">
                <span class="k">IP:</span> {{ a.ip or '—' }} &nbsp; • &nbsp;
                <span class="k">At:</span> {{ a.created_at }}
              </div>
            </div>
            <div class="text-end small mut" style="max-width:50%">
              <div class="k">User-Agent</div>
              <div>{{ a.user_agent or '—' }}</div>
            </div>
          </div>

          {% if a.extra %}
            <div class="mt-2">
              <div class="mut small mb-1">Extra</div>
              <pre class="audit-json">{{ a.extra | tojson(indent=2) }}</pre>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-secondary mb-0">No audit events yet.</div>
    {% endif %}
  </div>
</div>

<script>
  // theme toggle (match rest of app)
  const tbtn = document.getElementById('theme_toggle_audit');
  function applyTheme(t){
    if(t==='dark') document.body.classList.add('theme-dark'); else document.body.classList.remove('theme-dark');
    localStorage.setItem('sentinel_theme', t);
  }
  tbtn.addEventListener('click', ()=>{
    const cur = localStorage.getItem('sentinel_theme') || 'light';
    applyTheme(cur === 'light' ? 'dark' : 'light');
  });
  (function(){ applyTheme(localStorage.getItem('sentinel_theme') || 'light'); })();
</script>
{% endblock %}